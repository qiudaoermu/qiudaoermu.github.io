---
title: "ğŸŒ¦ğŸŒ¦å‰ç«¯å¤§æ–‡ä»¶ä¸Šä¼ "
date: 2022-07-12
tags: 
- å¼€å‘æ—¥å¸¸
---
![](https://upload-images.jianshu.io/upload_images/15312191-18c6200c98115ddc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### èƒŒæ™¯ï¼š
å‰ç«¯æ–‡ä»¶ä¸Šä¼ æ˜¯éå¸¸æ™®éçš„åŠŸèƒ½ï¼Œå½“éœ€è¦ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ã€‚

1.å‰åç«¯ä¸Šä¼ æ—¶é—´é™åˆ¶ï¼Œä¸€æ¬¡æ€§ä¼ è¾“å¤§å°é™åˆ¶ã€‚
2.ç½‘ç»œæŠ–åŠ¨ç­‰ï¼Œå¤±è´¥åéœ€è¦é‡æ–°ä¸Šä¼ ã€‚

#### ä¸»è¦æ­¥éª¤ï¼š

**å‰ç«¯**ï¼š
**åŠ è½½æ–‡ä»¶ â¡ï¸  åˆ†ç‰‡ â¡ï¸  ä¸Šä¼ **

**node.js**ï¼š
**è§£ææ–‡ä»¶**  â¡ï¸   **å­˜æ”¾æ–‡ä»¶ç¢ç‰‡**  â¡ï¸   **åˆå¹¶æ–‡ä»¶**


#### 1.æµè§ˆå™¨åŠ è½½æ–‡ä»¶

```html
  <input id="file" type="file" onchange="uploadFile()"id="upload" />
  <input type="button" id="upload" value="æ–‡ä»¶ä¸Šä¼ " class="btn btn-warning"  onclick="handleUpload()" />
```

è¿™ä¸€æ­¥ä¸»è¦æ˜¯æŠŠæ–‡ä»¶è¯»å–åˆ°å†…å­˜é‡Œã€‚

document.getElementById('file').files æ˜¯ FileListç±»å‹ã€‚

document.getElementById('file').files[0] æ˜¯Fileç±»å‹çš„åŒ…è£…å™¨ã€‚

> File FileList FileReaderå…³ç³»ï¼š
FileReaderåªèƒ½è¯»å– Fileæˆ–è€… blobå¯¹è±¡ï¼ŒFileå¯¹è±¡æ˜¯[`FileList`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileList)çš„å­é›†ï¼Œconstructor ==  Blob, æœ‰sliceæ–¹æ³•ã€‚

#### 2.ä¸Šä¼ æ–‡ä»¶æ–¹å¼é€‰æ‹©
æ–‡ä»¶ä¸Šä¼ é‡‡ç”¨ formDataå½¢å¼ï¼Œè€Œä¸æ˜¯jsonã€‚åŸå› jsonä¼ å‚éœ€è¦JSON. stringifyåºåˆ—åŒ–
æ¯”å¦‚ä¸€ä¸‹ä»£ç ï¼š
```
var xhr = new XMLHttpRequest();
xhr.open('post','http://localhost:3000/ajaxpost');
xhr.setReuqestHeader('Content-Type','application/json');
var params = JSON.stringify({
    city: 'é‡åº†',
    spcial: 'å±±åŸ'
})
xhr.send(params);
xhr.onload = function () {
    console.log(xhr.responseText);    
}
```

åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šæŠ¹æ‰ä¸€äº›æ¯”å¦‚ function File blobçš„å¯¹è±¡ï¼Œæ‰€ä»¥é‡‡ç”¨formDataå½¢å¼è¿›è¡Œæ–‡ä»¶ä¸Šä¼ ã€‚


#### 3.åˆ†ç‰‡ä¸Šä¼ 
##### 3.1 æ–‡ä»¶åˆ‡å‰²
Fileå¯¹è±¡å¯ä»¥ä½¿ç”¨ï¼Œslice + File.sizeï¼Œå¯¹æ–‡ä»¶è¿›è¡Œåˆ‡å‰²ï¼Œåˆ‡å‰²åçš„chunkå®é™…ä¸Šæ˜¯æµè§ˆå™¨å¯¹è±¡Blobã€‚

```js diff
 const url = "http://127.0.0.1:1000/file/uploading"
 const mergrUrl = "http://127.0.0.1:1000/file/mergrChunk"
 const handleUpload = () => {
        $("#file").click();
  }

  function uploadFile() {
      const file = document.getElementById('file').files[0];
      chunkedUpload(file)
  }

```
+ åˆ†ç‰‡ä¸Šä¼ 
```
 const chunkedUpload = async (file) => {
      const chunkSize = 1024;
      for (let start = 0; start <= file.size; start += chunkSize) {
        const chunk = file.slice(start, start + chunkSize); // åˆ†ç‰‡ blobå¯¹è±¡
        const fd = new FormData();
        fd.append("chunk", chunk);
        fd.append("hash", start);
        fd.append("fileName", file.name)
        // ä¸Šä¼  åˆ©ç”¨asyncå®ç°ï¼ŒåŒæ­¥è¯·æ±‚
        let per = Math.floor(100 * start / file.size );

        if ((file.size - start) < chunkSize) {
          per = 100;
        }
     
        await postAjax(url, fd).then(res => {
          $('#bar').css({'width': per + "%",});
          $('#bar').html(per + '%');
        })
      }
``` 
+ Promise å°è£… ajax
```
 const postAjax = (url,fd) => {
      const xhr = new XMLHttpRequest();
      return new Promise((resolve, reject) => {
        xhr.open('POST', url, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4 && xhr.status == 200) {
            console.log(xhr.responseText, "responseText" )
            resolve(xhr.responseText)
          }
        };
        xhr.send(fd);
      })
    }
```
##### 3.2 å¹¶å‘è¯·æ±‚æé«˜ä¼ è¾“é€Ÿåº¦
ä¸ºäº†åˆ©ç”¨æµè§ˆå™¨çš„å¹¶å‘èƒ½åŠ›ï¼ŒæŠŠè¯·æ±‚åˆ†æ‰¹å‘é€ï¼Œæ¯æ¬¡å¹¶å‘11ä¸ªï¼Œnode.jsåŒä¸€ä¸ªIPæœ€å¤šå¯ä»¥å¼‚æ­¥å¤„ç†11ä¸ªè¯·æ±‚ã€‚
```diff



const chunkedUpload = async (file) => {
+ const chunkSize = 1024;
+ let postQueue = [];
+ const parallelNum = 11; //è°·æ­Œæœ€å¤§çº¿ç¨‹æ•°é‡ å¤§äº11åææ•ˆä¸æ˜æ˜¾
        for (let start = 0; start <= file.size; start += chunkSize) {
          const chunk = file.slice(start, start + chunkSize); // åˆ†ç‰‡ blobå¯¹è±¡
          const fd = new FormData();
          fd.append("chunk", chunk);
+         fd.append("hash", start); //node.js æ¥å—æ—¶åšä¸ºæ–‡ä»¶å
          fd.append("fileName", file.name)

+         let per = Math.floor(100 * start / file.size );
          
+         if ((file.size - start) < chunkSize) {
+            per = 100;
+          }
        
+          // ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å®Œï¼Œå†å‘é€å¦ä¸€ä¸ª
-        await postAjax(url, fd).then(res => {
-        })
+        if (postQueue.length < parallelNum) {
+           postQueue.push(postAjax(url, fd))
+        }

+        if (postQueue.length >= parallelNum || per === 100) {
+            // 6ä¸ªè¯·æ±‚å¹¶å‘
+            await Promise.all(postQueue).then(res => {
               $('#bar').css({'width': per + "%",});
               $('#bar').html(per + '%');
+              postQueue = [];
+            }).catch(err => {
+                console.error(err)
+            })
+          }
+        }
};
```
#### 4.æ–‡ä»¶æ¥æ”¶
##### 4.1 node.js æ¥æ”¶æ–‡ä»¶æµ
+ app.js æ¥æ”¶æ–‡ä»¶æµ
```js
const express = require("express");
const app = express();
app.use(express.static("public"));
const multiparty = require("multiparty");
const fs = require("fs-extra");

const path = require("path");
const UPLOAD_DIR = path.resolve(__dirname);


app.get("/", (req, res) => {
  res.sendFile(`${__dirname}/index.html`);
});
let FILE_NAME = "";
let chunkDir = "";

app.post("/file/uploading", (req, res, next) => {
  /* ç”Ÿæˆmultipartyå¯¹è±¡ï¼Œå¹¶é…ç½®ä¸Šä¼ ç›®æ ‡è·¯å¾„ */
  var form = new multiparty.Form();
  form.parse(req, async (err, fields, files) => {
    if(err) return;
    const [chunk] = files.chunk;
    const [hash] = fields.hash;
    const [fileName] = fields.fileName;
    FILE_NAME = fileName;
    chunkDir = path.resolve(UPLOAD_DIR, "fileSteam/fchunkDir" + fileName);

    if (!fs.existsSync(chunkDir)) {
      await fs.mkdirs(chunkDir);
    }
    // æ–‡ä»¶æš‚æ—¶æ”¾å…¥ chunkDiræ–‡ä»¶å¤¹ä¸­

    await fs.move(chunk.path, `${chunkDir}/${hash}`);

    res.writeHead(200, { "content-type": "text/plain;charset=utf-8" });
    res.write("200");
    res.end();
  });
});


app.use(express.static("public")).listen(1000);

```
ä¸Šé¢çš„app.js è§£ææ–‡ä»¶ï¼Œç„¶åä¸´æ—¶å­˜æ”¾åœ¨ chunkDir+æ–‡ä»¶åçš„æ–‡ä»¶å¤¹ä¸‹
![](https://upload-images.jianshu.io/upload_images/15312191-170c242f33c2b3b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



##### 4.2 node.js åˆå¹¶æ–‡ä»¶æµ ğŸ”œ ç”Ÿæˆæ–‡ä»¶
+ app.js
```diff js
app.post("/file/uploading", (req, res, next) => {
   ......
});

// åˆå¹¶chunk
+ const stream = require("./writeStream");

+ app.post("/file/mergrChunk", async (req, res, next) => {
+  FILE_NAME = path.resolve(UPLOAD_DIR, "fileSteam/" + FILE_NAME);
+  console.log(FILE_NAME, "========================");
+  let dests = fs.readdirSync(chunkDir);
+  dests = dests.sort((a, b) => a - b);
+  await stream.WriteStreamsAsync(dests, FILE_NAME, chunkDir);
+  await fs.removeSync(chunkDir);
+  res.write("200");
+  res.end();
});

app.use(express.static("public")).listen(1000);

```

å‰ç«¯æ–‡ä»¶ä¼ é€å®Œæˆï¼Œå‘åç«¯å‘é€ä¸€ä¸ªåˆå¹¶è¯·æ±‚ï¼Œåˆå¹¶å‰æŠŠæ–‡ä»¶æ’åºä¸€ä¸‹ï¼Œæ–‡ä»¶åˆå¹¶æ“ä½œåœ¨writeStream.jsä¸­ã€‚

+ writeStream.js

```js
const fs = require("fs"); // å¼•å…¥fsæ¨¡å—
const path = require("path");
/**
 * @params dests æ–‡ä»¶æµ
 * @params FILE_NAME  ç”Ÿæˆçš„æ–‡ä»¶å
 * @params chunkDir æ–‡ä»¶è·¯å¾„
 */
const WriteStreamsAsync = async (dests, FILE_NAME, chunkDir) => {
  let writeable = fs.createWriteStream(FILE_NAME);
  for (let i = 0; i < dests.length; i++) {
    await write(dests[i], writeable, chunkDir);
  }
};

const write = (item, writeable, chunkDir) => {
  return new Promise((resolve, reject) => {
    let destPath = path.resolve(__dirname, chunkDir + '/' + item);
    let readable = fs.createReadStream(destPath);
    readable.pipe(writeable, { end: false });
    readable.on("end", () => {
      // å…³é—­æµä¹‹å‰ç«‹å³å†™å…¥æœ€åä¸€ä¸ªé¢å¤–çš„æ•°æ®å—
      resolve();
    });
  });
};

module.exports = { WriteStreamsAsync };

```

åˆ©ç”¨  fs. createReadStream fs. createWriteStream æ–‡ä»¶æµapiåˆå¹¶æ–‡ä»¶åˆ‡ç‰‡ï¼Œç”Ÿæˆæ–‡ä»¶ã€‚

[gitä»£ç åœ°å€](https://github.com/qiudaoermu/node-upload.git)
